machine:
  services:
    - docker
  environment:
    PATH: "${PATH}:${GOPATH}/bin"
    
dependencies:
  pre:
    # Pull down vendored dependencies
    - mkdir -p $GOPATH/bin
    - curl "https://glide.sh/get" | sh
    - glide install
    # Build polymer UI
    - npm install
  override:
    # prepare qemu
    - docker run --rm --privileged multiarch/qemu-user-static:register --reset

    # Build go server for amd64
    - GOOS=linux GOARCH=amd64 go build -o gomp-linux-amd64
    - docker build -t cwmr/gomp:latest .

    # Build go server for armhf
    - GOOS=linux GOARCH=arm go build -o gomp-linux-arm
    - docker build -t cwmr/gomp:armhf -f Dockerfile.armhf .

deployment:
  master:
    branch: master
    commands:
      - docker login -e $DOCKER_EMAIL -u $DOCKER_USER -p $DOCKER_PASSWORD
      - docker push cwmr/gomp:latest
  feature:
    branch: /feature\/.*/
    commands:
      - docker tag cwmr/gomp:latest cwmr/gomp:dev
      - docker login -e $DOCKER_EMAIL -u $DOCKER_USER -p $DOCKER_PASSWORD
      - docker push cwmr/gomp:dev
