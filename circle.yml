machine:
  services:
    - docker
    
dependencies:
  pre:
    # Pull down vendored dependencies
    - sudo add-apt-repository ppa:masterminds/glide -y
    - sudo apt-get update
    - sudo apt-get install glide -y
    - glide install
    # Build polymer UI
    - npm install
  override:
    # prepare qemu
    - docker run --rm --privileged multiarch/qemu-user-static:register --reset

    # Build go server for amd64
    - GOOS=linux GOARCH=amd64 go build -o gomp-linux-amd64
    - docker build -t cwmr/gomp:latest .

    # Build go server for armhf
    - GOOS=linux GOARCH=arm go build -o gomp-linux-arm
    - docker build -t cwmr/gomp:armhf -f Dockerfile.armhf .

deployment:
  master:
    branch: master
    commands:
      - docker login -e $DOCKER_EMAIL -u $DOCKER_USER -p $DOCKER_PASSWORD
      - docker push cwmr/gomp:latest
  feature:
    branch: /feature\/.*/
    commands:
      - docker tag cwmr/gomp:latest cwmr/gomp:dev
      - docker login -e $DOCKER_EMAIL -u $DOCKER_USER -p $DOCKER_PASSWORD
      - docker push cwmr/gomp:dev
