{{ define "css-recipe/list" }}
<style>
    .compact-image {
        box-sizing: initial;
        width: 32px;
        height: 32px;
        vertical-align: middle;
        padding: 5px;
    }
}
</style>
{{ end }}

{{ define "content-recipe/list" }}
<section class="row">
    <div class="col s12 l12">
        <div class="section">
            {{if (or .SearchQuery .SearchTags)}}
            <span class="light left">
                Search: '{{.SearchQuery}}', Results: {{.ResultCount}}
            </span>
            {{end}}
            <span class="right">
                <a id="recipe-list-menu-button" href="#!" data-activates="recipe-list-menu" class="button-collapse show-on-large">
                    <i class="material-icons black-text">menu</i>
                </a>
                <form>
                    <ul id="recipe-list-menu" class="side-nav collapsible flex-container" data-collapsible="expandable">
                        <li>
                            <a class="btn waves-effect" href="?reset">Reset</a>
                        </li>
                        <li>
                            <span class="collapsible-header active">Display</span>
                            <ul class="collapsible-body">
                                <li {{if eq .ViewType "full"}}class="active"{{end}}>
                                    <a href="?view=full"><i class="material-icons">view_agenda</i> Full</a>
                                </li>
                                <li {{if eq .ViewType "compact"}}class="active"{{end}}>
                                    <a href="?view=compact"><i class="material-icons">view_headline</i> Compact</a>
                                </li>
                            </ul>
                        </li>
                        <li>
                            <span class="collapsible-header active">Sort</span>
                            <ul class="collapsible-body">
                                <li {{if eq .SortType "name"}}class="active"{{end}}>
                                    <a href="?sort=name&dir={{if or (ne .SortType "name") (eq .SortDirType "DESC")}}ASC{{else}}DESC{{end}}">
                                        <i class="material-icons">sort_by_alpha</i> Name
                                    </a>
                                </li>
                                <li {{if eq .SortType "rating"}}class="active"{{end}}>
                                    <a href="?sort=rating&dir={{if and (eq .SortType "rating") (eq .SortDirType "DESC")}}ASC{{else}}DESC{{end}}">
                                        <i class="material-icons">star_rate</i> Rating
                                    </a>
                                </li>
                            </ul>
                        </li>
                        <li>
                            <span class="collapsible-header active">Filter by Tag</span>
                            <button class="btn-flat waves-effect header-btn" type="submit">Apply</button>
                        </li>
                        <li class="indented fill">
                            <ul>
                                {{range .AllTags}}
                                <li>
                                    <input id="{{.}}-tag" name="tags" type="checkbox" value="{{.}}" {{if StrSliceContains $.SearchTags .}}checked{{end}}>
                                    <label for="{{.}}-tag">{{.}}</label>
                                </li>
                                {{end}}
                            </ul>
                            </div>
                        </li>
                    </ul>
                </form>
            </span>
        </div>
    </div>

    {{template "pagination-recipe/list" .}}

    <div id="recipes-container">
        <div class="progress">
            <div class="indeterminate"></div>
        </div>
    </div>

    {{template "pagination-recipe/list" .}}

</section>
<section class="fixed-action-btn">
    <a href="{{RootUrlPath}}/new" class="btn-floating btn-large waves-effect green">
        <i class="material-icons">add</i>
    </a>
</section>
{{ end }}

{{define "pagination-recipe/list"}}
{{$baseLink := .SearchQuery | printf "?q=%s&page="}}
<ul class="pagination no-padding col s12 l12 center">
    <li class="{{if le .PageNum 1}}disabled{{end}} no-padding">
        <a href="{{if gt .PageNum 1}}{{$baseLink}}1{{else}}#{{end}}"><i class="material-icons">first_page</i></a>
    </li>
    <li class="{{if le .PageNum 1}}disabled{{end}} no-padding">
        <a href="{{if gt .PageNum 1}}{{$baseLink}}{{Add .PageNum -1}}{{else}}#{{end}}"><i class="material-icons">chevron_left</i></a>
    </li>
    {{range  Paginate .PageNum .NumPages 5}}
    <li {{if eq $.PageNum .}}class="active"{{end}}>
        <a href="{{$baseLink}}{{.}}">{{.}}</a>
    </li>
    {{end}}
    <li class="{{if ge .PageNum .NumPages}}disabled{{end}} no-padding">
        <a href="{{if lt .PageNum .NumPages}}{{$baseLink}}{{Add .PageNum 1}}{{else}}#{{end}}"><i class="material-icons">chevron_right</i></a>
    </li>
    <li class="{{if ge .PageNum .NumPages}}disabled{{end}} no-padding">
        <a href="{{if lt .PageNum .NumPages}}{{$baseLink}}{{.NumPages}}{{else}}#{{end}}"><i class="material-icons">last_page</i></a>
    </li>
</ul>
{{end}}

{{define "js-recipe/list"}}
<script type="text/javascript">
    $(document).ready(function(){
        $('#recipe-list-menu-button').sideNav({
            edge: 'right'
        });
        
        loadRecipes($('#recipes-container'), {
            q: '{{.SearchQuery}}',
            tags: [{{range .SearchTags}}'{{.}}', {{end}}],
            sort: '{{.SortType}}',
            dir: '{{.SortDirType}}',
            page: {{.PageNum}},
            count: {{.PerPage}},
        });
    });

    function loadRecipes($container, searchFilter) {
        getRecipesAsync('{{RootUrlPath}}', searchFilter).done(function(recipes) {
            $container.empty();

            if (recipes != null) {
                {{if ne $.ViewType "compact"}}
                addRecipesFull($container, recipes);
                {{else}}
                addRecipesCompact($container, recipes);
                {{end}}
            }
        });
    }

    function addRecipesFull($container, recipes) {
        recipes.forEach(function(recipe) {
            var $recipeWrapper = $('\
                <div class="col s12 m6 l4"></div>');
            var $recipeContent = '\
                <div class="card small grey lighten-4 hoverable clickable"\
                    onclick="location.href = \'{{RootUrlPath}}/recipes/' + recipe.id + '\';"\
                    title="' + recipe.name +'">';
            if (recipe.mainImage.thumbnailUrl != '') {
                $recipeContent += '\
                    <div class="card-image">\
                        <img src="' + recipe.mainImage.thumbnailUrl + '" class="darken-10">\
                    </div>';
            }
            $recipeContent += '\
                    <div class="rating-container">\
                        <span class="star whole" data-rating="5"><i class="material-icons">star</i></span>\
                        <span class="star half" data-rating="4.5"><i class="material-icons">star</i></span>\
                        <span class="star whole" data-rating="4"><i class="material-icons">star</i></span>\
                        <span class="star half" data-rating="3.5"><i class="material-icons">star</i></span>\
                        <span class="star whole" data-rating="3"><i class="material-icons">star</i></span>\
                        <span class="star half" data-rating="2.5"><i class="material-icons">star</i></span>\
                        <span class="star whole" data-rating="2"><i class="material-icons">star</i></span>\
                        <span class="star half" data-rating="1.5"><i class="material-icons">star</i></span>\
                        <span class="star whole" data-rating="1"><i class="material-icons">star</i></span>\
                        <span class="star half" data-rating="0.5"><i class="material-icons">star</i></span>\
                    </div>\
                    <div class="card-content truncate">\
                        <span class="card-title">' + recipe.name + '</span>\
                    </div>\
                </div>';
            $recipeWrapper.append($recipeContent);
            $container.append($recipeWrapper);
            $recipeWrapper.find('.star[data-rating="' + recipe.averageRating + '"]').addClass('active');
        });
    }

    function addRecipesCompact($container, recipes) {
        var columnizedRecipes = splitArray(recipes, 4);
        columnizedRecipes.forEach(function(innerRecipes) {
            var $innerContainer = $('<div class="col s12 m6 l3"></div>');
            $container.append($innerContainer);

            innerRecipes.forEach(function(recipe) {
                var $recipeWrapper = $('\
                    <div class="col s12 l12"></div>');
                var $recipeContent = '\
                    <a href="{{RootUrlPath}}/recipes/' + recipe.id + '" class="truncate" title="' + recipe.name + '">\
                        <img class="compact-image circle">\
                        <span>' + recipe.name + '</span>\
                    </a>';
                $recipeWrapper.append($recipeContent);
                $innerContainer.append($recipeWrapper);
                if (recipe.mainImage.thumbnailUrl != '') {
                    $recipeWrapper.find('img').attr('src', recipe.mainImage.thumbnailUrl);
                }
            });
        });
    }

    function splitArray(items, numSplits) {
        var splitCount = Math.ceil(items.length / numSplits)

        var newArrays = [[]];
        var index = 0

        for (i = 0; i < items.length; i++) {
            if (i >= (index + 1) * splitCount) {
                newArrays.push([]);
                index++;
            }
            newArrays[index].push(items[i]);
        }

        return newArrays;
    }
</script>
{{end}}
