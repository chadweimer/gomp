<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/polymer/lib/mixins/gesture-event-listeners.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-card/paper-card.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-password-input/paper-password-input.html">

<link rel="import" href="mixins/gomp-core-mixin.html">

<link rel="import" href="shared-styles.html">

<dom-module id="login-view">
    <template>
        <style include="shared-styles">
            :host {
                display: block;
                padding: 8px;
            }
            .container {
                @apply --layout-horizontal;
                @apply --layout-center-justified;
            }
            .error {
                color: red;
            }
            @media screen and (min-width: 601px) {
                paper-card {
                    width: 50%;
                }
            }
            @media screen and (max-width: 600px) {
                paper-card {
                    width: 100%;
                }
            }
        </style>
        <div class="container">
            <paper-card heading="Login">
                <div class="card-content">
                    <paper-input name="username" value="{{username}}" label="Email" on-keydown="_onInputKeydown" required autofocus autocomplete></paper-input>
                    <paper-password-input name="password" value="{{password}}" label="Password" on-keydown="_onInputKeydown" required></paper-password-input>
                    <div class="error">[[errorMessage]]</div>
                </div>
                <div class="card-actions">
                    <paper-button id="loginButton" on-tap="_onLoginTapped">Login</paper-button>
                </div>
            </paper-card>
        </div>

        <iron-ajax bubbles
            id="authAjax"
            url="/api/v1/auth"
            method="POST"
            handle-as="json"
            on-request="_handlePostAuthRequest"
            on-response="_handlePostAuthResponse"
            on-error="_handlePostAuthError"></iron-ajax>
    </template>

    <script>
        class LoginView extends GompCoreMixin(Polymer.GestureEventListeners(Polymer.Element)) {
            static get is() { return 'login-view'; }
            static get properties() {
                return {
                    username: {
                        type: String,
                        notify: true,
                    },
                    password: {
                        type: String,
                        notify: true,
                    },
                    errorMessage: {
                        type: String,
                        notify: true,
                    },
                };
            }

            _isActiveChanged(isActive) {
                if (isActive) {
                    this.username = '';
                    this.password = '';
                    this.errorMessage = '';
                }
            }
            _onLoginTapped(e) {
                e.preventDefault();

                this.$.authAjax.body = JSON.stringify({'username': this.username, 'password': this.password});
                this.$.authAjax.generateRequest();
            }
            _onInputKeydown(e) {
                if (e.keyCode === 13) {
                    this.$.loginButton.click();
                }
            }
            _handlePostAuthRequest(e) {
                this.errorMessage = '';
            }
            _handlePostAuthResponse(e) {
                localStorage.setItem('username', this.username);
                localStorage.setItem('jwtToken', e.detail.response.token);
                this.dispatchEvent(new CustomEvent('authenticated', {detail: {jwtToken: e.detail.response.token}}));
                this.dispatchEvent(new CustomEvent('change-page', {detail: {url: '/home'}}));
            }
            _handlePostAuthError () {
                this.password = '';
                this.errorMessage = 'Login failed. Check your username and password and try again.';
            }
        }

        window.customElements.define(LoginView.is, LoginView);
    </script>
</dom-module>
