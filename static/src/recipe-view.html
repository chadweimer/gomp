<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../bower_components/iron-location/iron-location.html">
<link rel="import" href="../bower_components/iron-icons/image-icons.html">
<link rel="import" href="../bower_components/iron-icons/editor-icons.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-card/paper-card.html">
<link rel="import" href="../bower_components/paper-chip/paper-chip.html">
<link rel="import" href="../bower_components/paper-chip/paper-chips-section.html">
<link rel="import" href="../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../bower_components/paper-divider/paper-divider.html">
<link rel="import" href="../bower_components/paper-fab-speed-dial/paper-fab-speed-dial.html">
<link rel="import" href="../bower_components/paper-fab-speed-dial/paper-fab-speed-dial-action.html">
<link rel="import" href="../bower_components/paper-input/paper-textarea.html">
<link rel="import" href="../bower_components/paper-progress/paper-progress.html">

<link rel="import" href="components/image-list.html">
<link rel="import" href="components/note-list.html">

<dom-module id="recipe-view">
    <template>
        <style>
            :host {
                display: block;
                color: var(--primary-text-color);

                --paper-card: {
                    width: 100%;
                }
            }
            article {
                padding: 8px;
            }
            section {
                padding: 0.5em;
            }
            a {
                text-transform: none;
            }
            paper-progress {
                width: 100%;
            }
            label {
                color: var(--secondary-text-color);
                font-size: 0.7em;
                font-weight: lighter;
            }
            .plain-text {
                white-space: pre-wrap;
            }
            .avatar {
                width: 64px;
                height: 64px;
                border-radius: 32px;
            }
            .rating-container {
                position: absolute;
                top: 5px;
                right: 5px;
            }
            .rating-container > iron-icon {
                color: #dddddd;
                float: right;
            }
            .rating-container > iron-icon.whole {
                -webkit-clip-path: inset(0 0 0 50%);
                   -moz-clip-path: inset(0 0 0 50%);
                    -ms-clip-path: inset(0 0 0 50%);
                     -o-clip-path: inset(0 0 0 50%);
                        clip-path: inset(0 0 0 50%);
                margin-left: -100%;
            }
            .rating-container > iron-icon.half {
                -webkit-clip-path: inset(0 50% 0 0);
                   -moz-clip-path: inset(0 50% 0 0);
                    -ms-clip-path: inset(0 50% 0 0);
                     -o-clip-path: inset(0 50% 0 0);
                        clip-path: inset(0 50% 0 0);
            }
            .rating-container > iron-icon.active,
            .rating-container > iron-icon.active ~ iron-icon {
                color: #fdd835;
            }
            .rating-container > iron-icon:hover,
            .rating-container > iron-icon:hover ~ iron-icon {
                color: #ffeb3b !important;
            }
            paper-fab-speed-dial-action.green {
                --paper-fab-speed-dial-action-background: var(--paper-green-500);
                --paper-fab-speed-dial-action-keyboard-focus-background: var(--paper-green-900);
            }
            paper-fab-speed-dial-action.red {
                --paper-fab-speed-dial-action-background: var(--paper-red-500);
                --paper-fab-speed-dial-action-keyboard-focus-background: var(--paper-red-900);
            }
            paper-fab-speed-dial-action.amber {
                --paper-fab-speed-dial-action-background: var(--paper-amber-500);
                --paper-fab-speed-dial-action-keyboard-focus-background: var(--paper-amber-900);
            }
            paper-fab-speed-dial-action.teal {
                --paper-fab-speed-dial-action-background: var(--paper-teal-500);
                --paper-fab-speed-dial-action-keyboard-focus-background: var(--paper-teal-900);
            }
            paper-fab-speed-dial-action.blue {
                --paper-fab-speed-dial-action-background: var(--paper-blue-500);
                --paper-fab-speed-dial-action-keyboard-focus-background: var(--paper-blue-900);
            }
            .container {
                @apply(--layout-horizontal);
                @apply(--layout-wrap);
            }
            .tab {
                margin: 8px;
            }
            @media screen and (min-width: 993px) {
                .tab {
                    width: calc(50% - 16px);
                }
                paper-dialog {
                    width: 33%;
                }
            }
            @media screen and (min-width: 601px) and (max-width: 992px) {
                .tab {
                    width: calc(100% - 16px);
                }
                paper-dialog {
                    width: 75%;
                }
            }
            @media screen and (max-width: 600px) {
                .tab {
                    width: calc(100% - 16px);
                }
                paper-dialog {
                    width: 100%;
                }
            }
        </style>

        <paper-progress indeterminate hidden$="{{!loading}}"></paper-progress>
        <article>
            <paper-card>
                <div class="card-content">
                    <div id="ratings" class="rating-container">
                        <iron-icon icon="icons:star" class="whole" data-rating="5"></iron-icon>
                        <iron-icon icon="icons:star" class="half" data-rating="4.5"></iron-icon>
                        <iron-icon icon="icons:star" class="whole" data-rating="4"></iron-icon>
                        <iron-icon icon="icons:star" class="half" data-rating="3.5"></iron-icon>
                        <iron-icon icon="icons:star" class="whole" data-rating="3"></iron-icon>
                        <iron-icon icon="icons:star" class="half" data-rating="2.5"></iron-icon>
                        <iron-icon icon="icons:star" class="whole" data-rating="2"></iron-icon>
                        <iron-icon icon="icons:star" class="half" data-rating="1.5"></iron-icon>
                        <iron-icon icon="icons:star" class="whole" data-rating="1"></iron-icon>
                        <iron-icon icon="icons:star" class="half" data-rating="0.5"></iron-icon>
                    </div>
                    <h2>
                        <img src="[[mainImage.thumbnailUrl]]" class="avatar" hidden$="[[!mainImage.thumbnailUrl]]">
                        [[recipe.name]]
                    </h2>
                    <section hidden$="{{!recipe.servingSize}}">
                        <label>Serving Size</label>
                        <p class="plain-text">[[recipe.servingSize]]</p>
                        <paper-divider></paper-divider>
                    </section>
                    <section>
                        <label>Ingredients</label>
                        <p class="plain-text">[[recipe.ingredients]]</p>
                        <paper-divider></paper-divider>
                    </section>
                    <section>
                        <label>Directions</label>
                        <p class="plain-text">[[recipe.directions]]</p>
                        <paper-divider></paper-divider>
                    </section>
                    <section hidden$="{{!recipe.nutrition}}">
                        <label>Nutrition</label>
                        <p class="plain-text">[[recipe.nutrition]]</p>
                        <paper-divider></paper-divider>
                    </section>
                    <section hidden$="{{!recipe.sourceUrl}}">
                        <label>Source</label>
                        <p class="section"><a target="_blank" href$="[[recipe.sourceUrl]]" class="hideable-content">[[recipe.sourceUrl]]</a></p>
                        <paper-divider></paper-divider>
                    </section>
                    <paper-chips-section labels="[[recipe.tags]]"></paper-chips-section>
                </div>
            </paper-card>
            <div class="container">
                <div id="images" class="tab">
                    <h3>Pictures</h3>
                    <paper-divider></paper-divider>
                    <image-list jwt-token="[[jwtToken]]" recipe-id="[[recipeId]]"></image-list>
                </div>
                <div id="notes" class="tab">
                    <h3>Notes</h3>
                    <paper-divider></paper-divider>
                    <note-list id="noteList" jwt-token="[[jwtToken]]" recipe-id="[[recipeId]]"></note-list>
                </div>
            </div>
        </div>
        <paper-fab-speed-dial id="actions" icon="icons:more-vert">
            <paper-fab-speed-dial-action id="newButton" class="green" icon="icons:add">New</paper-fab-speed-dial-action>
            <paper-fab-speed-dial-action id="deleteButton" class="red" icon="icons:delete">Delete</paper-fab-speed-dial-action>
            <paper-fab-speed-dial-action id="editButton" class="amber" icon="icons:create">Edit</paper-fab-speed-dial-action>
            <paper-fab-speed-dial-action id="addImageButton" class="teal" icon="image:add-a-photo">Upload Picture</paper-fab-speed-dial-action>
            <paper-fab-speed-dial-action id="addNoteButton" class="blue" icon="editor:insert-comment">Add Note</paper-fab-speed-dial-action>
        </paper-fab-speed-dial>

        <paper-dialog id="noteDialog" entry-animation="scale-up-animation" exit-animation="fade-out-animation" with-backdrop>
            <h2><iron-icon icon="editor:insert-comment"></iron-icon> <span>Add Note</span></h2>
            <paper-textarea label="Text" value="{{noteText}}" rows="3" required autofocus></paper-textarea>
            <div class="buttons">
                <paper-button dialog-dismiss>Cancel</paper-button>
                <paper-button dialog-confirm>Save</paper-button>
            </div>
        </paper-dialog>

        <paper-dialog id="confirmDialog" entry-animation="scale-up-animation" exit-animation="fade-out-animation" with-backdrop>
            <h2><iron-icon icon="communication:live-help"></iron-icon> <span>Are you sure?</span></h2>
            <p>[[confirmationText]]</p>
            <div class="buttons">
                <paper-button dialog-dismiss>No</paper-button>
                <paper-button id="confirmYes" dialog-confirm>Yes</paper-button>
            </div>
        </paper-dialog>

        <iron-ajax
            auto
            id="getAjax"
            url="/api/v1/recipes/[[recipeId]]"
            headers="[[ajaxHeaders]]"
            method="GET"
            handle-as="json"
            on-request="_handleGetRecipeRequest"
            on-response="_handleGetRecipeResponse"
            on-error="_handleGetRecipeError"></iron-ajax>
        <iron-ajax
            id="deleteAjax"
            url="/api/v1/recipes/[[recipeId]]"
            method="DELETE"
            headers="[[ajaxHeaders]]"
            handle-as="json"
            on-response="_handleDeleteRecipeResponse"></iron-ajax>
        <iron-ajax
            auto
            id="mainImageAjax"
            url="/api/v1/recipes/[[recipeId]]/image"
            headers="[[ajaxHeaders]]"
            handle-as="json"
            on-request="_handleGetMainImageRequest"
            on-response="_handleGetMainImageResponse"></iron-ajax>
        <iron-ajax
            id="postNoteAjax"
            url="/api/v1/notes"
            method="POST"
            headers="[[ajaxHeaders]]"
            handle-as="json"
            on-response="_handlePostNoteResponse"></iron-ajax>
        <iron-ajax
            id="putNoteAjax"
            url="/api/v1/notes/[[noteId]]"
            method="PUT"
            headers="[[ajaxHeaders]]"
            handle-as="json"
            on-response="_handlePutNoteResponse"></iron-ajax>
        <iron-location id="ironLocation"></iron-location>
    </template>

    <script>
        Polymer({

            is: 'recipe-view',

            properties: {
                active: {
                    type: Boolean,
                    notify: true,
                    value: false,
                    observer: '_activeChanged'
                },
                jwtToken: {
                    type: String,
                    notify: true
                },
                ajaxHeaders: {
                    type: Object,
                    computed: '_getAjaxHeaders(jwtToken)'
                },
                recipeId: {
                    type: String,
                    notify: true
                },
                recipe: {
                    type: Object,
                    notify: true,
                    observer: '_recipeChanged'
                },
                mainImage: {
                    type: Object,
                    notify: true
                },
            },
            listeners: {
                'deleteButton.tap': '_deleteButtonTapped',
                'addNoteButton.tap': '_addNoteButtonTapped',
                'noteDialog.iron-overlay-closed': '_noteDialogClosed',
                'note-card-edit': '_editNoteTapped'
            },

            _getAjaxHeaders: function(jwtToken) {
                return {"Authorization": "Bearer " + jwtToken};
            },

            _activeChanged: function(newValue, oldValue) {
                if (!newValue) {
                    this.recipe = null;
                    this.mainImage = null;
                }
            },

            _recipeChanged: function(newValue, oldValue) {
                var stars = this.$.ratings.querySelectorAll(".rating-container > iron-icon");
                stars.forEach(function(star) {
                    if (newValue && star.dataset.rating === newValue.averageRating.toString()) {
                        star.classList.add("active");
                    } else {
                        star.classList.remove("active");
                    }
                });
            },

            _deleteButtonTapped: function(e) {
                this.confirmationText = "Are you sure you want to delete this recipe?";
                var self = this;
                this.$.confirmYes.onclick = function(e) {
                    self.$.deleteAjax.generateRequest();
                };
                this.$.confirmDialog.open();
                this.$.actions.close();
            },

            _addNoteButtonTapped: function(e) {
                this.noteId = null;
                this.noteText = '';
                this.$.actions.close();
                this.$.noteDialog.open();
            },
            _noteDialogClosed: function(e) {
                if (e.detail.confirmed) {
                    if (this.noteId) {
                        this.$.putNoteAjax.body = JSON.stringify({
                            "id": this.noteId,
                            "recipeId": this.recipe.id,
                            "text": this.noteText
                        });
                        this.$.putNoteAjax.generateRequest();
                    } else {
                        this.$.postNoteAjax.body = JSON.stringify({"recipeId": this.recipe.id, "text": this.noteText });
                        this.$.postNoteAjax.generateRequest();
                    }
                }
            },
            _editNoteTapped: function (e) {
                this.noteId = e.target.note.id;
                this.noteText = e.target.note.text;
                this.$.noteDialog.open();
            },

            _handleGetRecipeRequest: function(e) {
                this.loading = true;
                this.recipe = null;
            },
            _handleGetRecipeResponse: function(e) {
                this.recipe = e.detail.response;
                this.loading = false;
            },
            _handleGetRecipeError: function(e) {
                this.loading = false;
            },
            _handleDeleteRecipeResponse: function(e) {
                this.$.ironLocation.set("path", "/recipes");
            },
            _handleGetMainImageRequest: function(e) {
                this.mainImage = null;
            },
            _handleGetMainImageResponse: function(e) {
                this.mainImage = e.detail.response;
            },
            _handlePostNoteResponse: function(e) {
                this.$.noteList.refresh();
            },
            _handlePutNoteResponse: function(e) {
                this.$.noteList.refresh();
            }

        });
    </script>
</dom-module>
