<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/polymer/lib/mixins/gesture-event-listeners.html">
<link rel="import" href="../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/paper-card/paper-card.html">
<link rel="import" href="../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-password-input/paper-password-input.html">
<link rel="import" href="../bower_components/paper-spinner/paper-spinner.html">

<link rel="import" href="mixins/gomp-core-mixin.html">

<link rel="import" href="shared-styles.html">

<dom-module id="settings-view">
    <template>
        <style include="shared-styles">
            :host {
                display: block;

                --paper-card: {
                    width: 100%;
                }
            }
            .container {
                padding: 10px;
            }
            img.responsive {
                max-width: 100%;
                max-height: 20em;
                height: auto;
            }
            paper-fab.green {
                --paper-fab-background: var(--paper-green-500);
                --paper-fab-keyboard-focus-background: var(--paper-green-900);
                position: fixed;
                bottom: 16px;
                right: 16px;
            }
            paper-button > span {
                margin-left: 0.5em;
            }
            @media screen and (min-width: 993px) {
                .container {
                    width: 50%;
                    margin: auto;
                }
            }
            @media screen and (min-width: 601px) and (max-width: 992px) {
                .container {
                    width: 75%;
                    margin: auto;
                }
            }
            @media screen and (max-width: 600px) {
            }
        </style>
        <div class="container">
            <paper-card>
                <div class="card-content">
                    <h3>Security Settings</h3>
                    <paper-input label="Username" value="[[username]]" always-float-label disabled></paper-input>
                    <paper-password-input label="Current Password" value="{{currentPassword}}" always-float-label></paper-password-input>
                    <paper-password-input label="New Password" value="{{newPassword}}" always-float-label></paper-password-input>
                    <paper-password-input label="Confirm Password" value="{{repeatPassword}}" always-float-label></paper-password-input>
                </div>
                <div class="card-actions">
                    <paper-button on-tap="_updatePasswordTapped">
                        <iron-icon icon="icons:lock-outline"></iron-icon>
                        <span>Update Password</span>
                    <paper-button>
                </div>
            </paper-card>
        </div>
        <div class="container">
            <paper-card>
                <div class="card-content">
                    <h3>Home Settings</h3>
                    <paper-input label="Title" always-float-label value="{{homeTitle}}">
                        <paper-icon-button slot="suffix" icon="icons:save" on-tap="_saveButtonTapped"></paper-icon-button>
                    </paper-input>
                    <form id="homeImageForm" enctype="multipart/form-data">
                        <paper-input-container always-float-label>
                            <label slot="label">Image</label>
                            <iron-input slot="input">
                                <input id="homeImageFile" name="file_content" type="file" accept=".jpg,.jpeg,.png"></input>
                            </iron-input>
                            <paper-icon-button slot="suffix" icon="icons:file-upload" on-tap="_uploadButtonTapped"></paper-icon-button>
                          </paper-input-container>
                    </form>
                    <img alt="Home Image" src="[[homeImageUrl]]" class="responsive" hidden$="[[!homeImageUrl]]">
                </div>
            </paper-card>
        </div>
        <paper-dialog id="uploadingDialog" with-backdrop>
            <h3><paper-spinner active></paper-spinner>Uploading</h3>
        </paper-dialog>

        <a href="/create"><paper-fab icon="icons:add" class="green"></paper-fab></a>

        <iron-ajax bubbles
            id="getUserAjax"
            url="/api/v1/users/current"
            headers="[[ajaxHeaders]]"
            method="GET"
            handle-as="json"
            on-response="_handleGetUserResponse"></iron-ajax>
        <iron-ajax bubbles
            id="putPasswordAjax"
            url="/api/v1/users/current/password"
            headers="[[ajaxHeaders]]"
            method="PUT"
            handle-as="json"
            on-response="_handlePutPasswordResponse",
            on-error="_handlePutPasswordError"></iron-ajax>
        <iron-ajax bubbles
            id="getSettingsAjax"
            url="/api/v1/users/current/settings"
            headers="[[ajaxHeaders]]"
            method="GET"
            handle-as="json"
            on-response="_handleGetSettingsResponse"></iron-ajax>
        <iron-ajax bubbles
            id="putSettingsAjax"
            url="/api/v1/users/current/settings"
            headers="[[ajaxHeaders]]"
            method="PUT"
            handle-as="json"
            on-response="_handlePutSettingsResponse",
            on-error="_handlePutSettingsError"></iron-ajax>
        <iron-ajax bubbles
            id="postImageAjax"
            url="/api/v1/uploads"
            method="POST"
            headers="[[ajaxHeaders]]"
            handle-as="json"
            on-request="_handlePostImageRequest"
            on-response="_handlePostImageResponse",
            on-error="_handlePostImageError"></iron-ajax>
    </template>

    <script>
        class SettingsView extends GompCoreMixin(Polymer.GestureEventListeners(Polymer.Element)) {
            static get is() { return 'settings-view'; }

            ready() {
                super.ready();

                if (this.isActive) {
                    this._refresh();
                }
            }

            _updatePasswordTapped(e) {
                e.preventDefault();

                if (this.newPassword !== this.repeatPassword) {
                    this.showToast('Passwords don\'t match.');
                    return;
                }

                this.$.putPasswordAjax.body = JSON.stringify({
                    'currentPassword': this.currentPassword,
                    'newPassword': this.newPassword
                });
                this.$.putPasswordAjax.generateRequest();
            }
            _saveButtonTapped(e) {
                e.preventDefault();

                this.$.putSettingsAjax.body = JSON.stringify({
                    'homeTitle': this.homeTitle,
                    'homeImageUrl': this.homeImageUrl,
                });
                this.$.putSettingsAjax.generateRequest();
            }
            _uploadButtonTapped(e) {
                e.preventDefault();

                this.$.postImageAjax.body = new FormData(this.$.homeImageForm);
                this.$.postImageAjax.generateRequest();
            }

            _isActiveChanged(isActive) {
                this.$.homeImageFile.value = null;
                this.currentPassword = null;
                this.newPassword = null;
                this.repeatPassword = null;
                
                if (isActive && this.isReady) {
                    this._refresh();
                }
            }
            
            _handleGetUserResponse(e) {
                var user = e.detail.response;

                this.username = user.username;
            }
            _handlePutPasswordResponse(e) {
                this.showToast('Password updated.');
            }
            _handlePutPasswordError(e) {
                this.showToast('Password update failed!');
            }
            _handleGetSettingsResponse(e) {
                var userSettings = e.detail.response;

                this.homeTitle = userSettings.homeTitle;
                this.homeImageUrl = userSettings.homeImageUrl;
            }
            _handlePutSettingsResponse(e) {
                this._refresh();
                this.showToast('Settings changed.');
            }
            _handlePutSettingsError(e) {
                this.showToast('Updating settings failed!');
            }
            _handlePostImageRequest(e) {
                this.$.uploadingDialog.open();
            }
            _handlePostImageResponse(e, req) {
                this.$.uploadingDialog.close();
                this.$.homeImageFile.value = null;
                this.showToast('Upload complete.');

                var location = req.xhr.getResponseHeader('Location');
                this.$.putSettingsAjax.body = JSON.stringify({
                    'homeTitle': this.homeTitle,
                    'homeImageUrl': location,
                });
                this.$.putSettingsAjax.generateRequest();
            }
            _handlePostImageError(e) {
                this.$.uploadingDialog.close();
                this.showToast('Upload failed!');
            }

            _refresh() {
                this.$.getUserAjax.generateRequest();
                this.$.getSettingsAjax.generateRequest();
            }
        }

        window.customElements.define(SettingsView.is, SettingsView);
    </script>
</dom-module>
