<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/app-route/app-location.html">
<link rel="import" href="../bower_components/app-route/app-route.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../bower_components/iron-media-query/iron-media-query.html">
<link rel="import" href="../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../bower_components/iron-selector/iron-selector.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-drawer-panel/paper-drawer-panel.html">
<link rel="import" href="../bower_components/paper-header-panel/paper-header-panel.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/paper-item/paper-item.html">
<link rel="import" href="../bower_components/paper-menu/paper-menu.html">
<link rel="import" href="../bower_components/paper-search/paper-search.html">
<link rel="import" href="../bower_components/paper-styles/color.html">
<link rel="import" href="../bower_components/paper-styles/default-theme.html">
<link rel="import" href="../bower_components/paper-styles/shadow.html">
<link rel="import" href="../bower_components/paper-styles/typography.html">
<link rel="import" href="../bower_components/paper-toolbar/paper-toolbar.html">

<dom-module id="gomp-app">
    <template>
        <style>
            :host {
                display: block;
            }
            paper-toolbar a {
                color: #FFFFFF;
            }
        </style>

        <app-location id="appLocation" route="{{route}}"></app-location>
        <app-route
            route="{{route}}"
            pattern="/:page"
            data="{{routeData}}"
            tail="{{subroute}}"></app-route>

        <paper-drawer-panel id="drawerPanel" force-narrow>
            <paper-header-panel drawer>
                <paper-toolbar><span>[[title]]</span></paper-toolbar>
                <paper-menu selected="[[page]]" attr-for-selected="name" role="navigation">
                    <paper-item name="home"><a href="/">Home</a></paper-item>
                    <paper-item name="recipes"><a href="/recipes">Recipes</a></paper-item>
                    <paper-item name="logout"><a href="#!" on-tap="_onLogoutTapped">Logout</a></paper-item>
                </paper-menu>
            </paper-header-panel>
            <paper-header-panel main>
                <paper-toolbar>
                    <paper-icon-button class="menu-button" icon="menu" paper-drawer-toggle hidden$="{{largeLayout}}"></paper-icon-button>
                    <div class="title"><span hidden$="{{smallLayout}}">[[title]]</span></div>
                    <paper-item name="home" hidden$="{{!largeLayout}}"><a href="/">Home</a></paper-item>
                    <paper-item name="recipes" hidden$="{{!largeLayout}}"><a href="/recipes">Recipes</a></paper-item>
                    <paper-item name="logout" hidden$="{{!largeLayout}}"><a href="#!" on-tap="_onLogoutTapped">Logout</a></paper-item>
                    <paper-search-bar icon="search" on-paper-search-search="_onSearch" on-paper-search-clear="_onSearch"></paper-search-bar>
                </paper-toolbar>

                <iron-pages
                    selected="[[page]]"
                    attr-for-selected="name"
                    role="main">
                    <home-view name="home"></home-view>
                    <recipes-view id="recipesView" name="recipes"></recipes-view>
                    <login-view name="login"></login-view>
                </iron-pages>
            </paper-header-panel>
        </paper-drawer-panel>

        <iron-media-query query="max-width: 600px" query-matches="{{smallLayout}}"></iron-media-query>
        <iron-media-query query="min-width: 601px" query-matches="{{medLayout}}"></iron-media-query>
        <iron-media-query query="min-width: 993px" query-matches="{{largeLayout}}"></iron-media-query>
    </template>

    <script>
        Polymer({

            is: 'gomp-app',

            ready: function() {
                this.verifyIsAuthenticated();
            },

            properties: {
                title: {
                    type: String,
                    value: 'Go Meal Planner'
                },
                smallLayout: {
                    type: Boolean,
                    value: false,
                    observer: 'onLayoutChange'
                },
                medLayout: {
                    type: Boolean,
                    value: false,
                    observer: 'onLayoutChange'
                },
                largeLayout: {
                    type: Boolean,
                    value: false,
                    observer: 'onLayoutChange'
                },
                page: {
                    type: String,
                    reflectToAttribute: true,
                    observer: '_pageChanged'
                }
            },
            observers: [
                '_routePageChanged(routeData.page)'
            ],
            _routePageChanged: function(page) {
                this.page = page || 'home';
            },
            _pageChanged: function(page) {
                if (!this.verifyIsAuthenticated()) {
                    return;
                }

                // Load page import on demand. Show 404 page if fails
                var resolvedPageUrl = this.resolveUrl(page + '-view.html');
                this.importHref(resolvedPageUrl, null, null, true);

                // Make sure to close the drawer
                this.$.drawerPanel.closeDrawer();
            },
            onLayoutChange: function(dontcare) {
                this.$.drawerPanel.closeDrawer();
            },
            _onLogoutTapped: function(e) {
                e.preventDefault();
                this._logout();
            },
            verifyIsAuthenticated: function() {
                var jwtToken = localStorage.getItem("jwtToken");
                // Redirect to login if necessary
                if (this.$.appLocation.path !== '/login') {
                    if (jwtToken === null) {
                        this._logout();
                        return false;
                    }
                }
                return true;
            },
            _logout: function() {
                localStorage.clear();
                sessionStorage.clear();
                this.$.appLocation.path = '/login';
            },
            _onSearch: function(e) {
                this.$.recipesView.search = e.target.query;
                this.$.appLocation.path = '/recipes';
            }
        });
    </script>
</dom-module>
