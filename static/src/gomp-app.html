<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/polymer/lib/mixins/gesture-event-listeners.html">
<link rel="import" href="../bower_components/shadycss/apply-shim.html">
<link rel="import" href="../bower_components/app-layout/app-layout.html">
<link rel="import" href="../bower_components/app-route/app-location.html">
<link rel="import" href="../bower_components/app-route/app-route.html">
<link rel="import" href="../bower_components/app-storage/app-localstorage/app-localstorage-document.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/paper-item/paper-item.html">
<link rel="import" href="../bower_components/paper-progress/paper-progress.html">
<link rel="import" href="../bower_components/paper-search/paper-search-bar.html">
<link rel="import" href="../bower_components/paper-search/paper-filter-dialog.html">
<link rel="import" href="../bower_components/paper-toast/paper-toast.html">
<link rel="import" href="../bower_components/paper-styles/default-theme.html">
<link rel="import" href="../bower_components/paper-styles/paper-styles.html">
<link rel="import" href="../bower_components/paper-drawer/paper-drawer.html">
<link rel="import" href="../bower_components/paper-drawer/paper-drawer-icon-item.html">
<link rel="import" href="../bower_components/paper-drawer/paper-drawer-title.html">
<link rel="import" href="../bower_components/paper-drawer/paper-drawer-divider.html">

<link rel="import" href="shared-styles.html">

<dom-module id="gomp-app">
    <template>
        <style include="shared-styles">
            :host > * {
                --primary-color: var(--paper-blue-500);
                --accent-color: var(--paper-red-500);
                --light-accent-color: var(--paper-red-300);
                --dark-accent-color: var(--paper-red-700);
                @apply --paper-font-body1;
            }
            :host {
                display: block;
                @apply --layout-fullbleed;
            }
            iron-pages > :not(.iron-selected) {
                pointer-events: none;
            }

            app-toolbar {
                background: var(--primary-color);
                color: white;
            }
            app-toolbar a {
                color: white;
            }
            paper-search-bar {
                color: var(--light-theme-text-color);
            }
            paper-filter-dialog {
                --paper-filter-toolbar-background: var(--primary-color);
                --paper-filter-toolbar: {
                    background: var(--primary-color);
                    color: white;
                }
            }
            paper-progress {
                width: 100%;
            }
            paper-drawer {
                --paper-drawer-title-background-color: var(--primary-color);
            }
            main {
                @apply --layout-flex;
            }
            footer {
                color: white;
                background: var(--paper-grey-500);
                line-height: 24px;
            }
            footer a {
                color: white;
            }
            footer .copyright {
                background: var(--paper-grey-600);
                padding-top: 10px;
                padding-bottom: 10px;
                font-weight: lighter;
                font-size: 0.9em;
            }
            @media screen and (min-width: 993px) {
                .hide-on-large-only {
                    display: none;
                }
            }
            @media screen and (max-width: 992px) {
                .hide-on-med-and-down {
                    display: none;
                }
            }
            @media screen and (min-width: 601px) {
                .indented {
                    padding-left: 150px;
                    padding-right: 150px;
                }
            }
            @media screen and (max-width: 600px) {
                .hide-on-small-only {
                    display: none;
                }
                .indented {
                    padding-left: 15px;
                    padding-right: 15px;
                }
            }
        </style>

        <app-location route="{{route}}"></app-location>
        <app-route route="{{route}}" pattern="/:page" data="{{routeData}}" tail="{{subroute}}"></app-route>

        <app-drawer-layout force-narrow fullbleed>
            <app-drawer id="drawer" slot="drawer" swipe-open>
                <paper-drawer>
                    <paper-drawer-title photo="/static/android-chrome-192x192.png" name="[[title]]" on-tap="_onHomeTapped"></paper-drawer-title>
                    <paper-drawer-icon-item icon="icons:home" on-tap="_onHomeTapped">Home</paper-drawer-icon-item>
                    <paper-drawer-icon-item icon="icons:view-list" on-tap="_onRecipesTapped">Recipes</paper-drawer-icon-item>
                    <paper-drawer-divider></paper-drawer-divider>
                    <paper-drawer-icon-item icon="icons:settings" on-tap="_onSettingsTapped">Settings</paper-drawer-icon-item>
                    <paper-drawer-icon-item icon="icons:exit-to-app" on-tap="_onLogoutTapped">Logout</paper-drawer-icon-item>
                </paper-drawer>
            </app-drawer>
            <app-header-layout id="mainPanel" fullbleed has-scrolling-region>
                <app-header id="mainHeader" slot="header" reveals shadow>
                    <div hidden$="[[jwtToken]]">
                        <app-toolbar>
                            <div main-title>[[title]]</div>
                        </app-toolbar>
                    </div>
                    <div hidden$="[[!jwtToken]]">
                        <app-toolbar>
                            <paper-icon-button class="menu-button hide-on-large-only" icon="menu" drawer-toggle></paper-icon-button>
                            <a href="/" class="hide-on-small-only">[[title]]</a>
                            <div main-title></div>
                            <a href="/home"><paper-item name="home" class="hide-on-med-and-down">Home</paper-item></a>
                            <a href="/search"><paper-item name="search" class="hide-on-med-and-down">Recipes</paper-item></a>
                            <a href="/settings"><paper-item name="settings" class="hide-on-med-and-down">Settings</paper-item></a>
                            <a href="#!" on-tap="_onLogoutTapped"><paper-item name="logout" class="hide-on-med-and-down">Logout</paper-item></a>

                            <paper-search-bar
                                icon="search"
                                query="[[search.query]]"
                                nr-selected-filters="[[selectedSearchFiltersCount]]"
                                on-paper-search-search="_onSearch"
                                on-paper-search-clear="_onSearch"
                                on-paper-search-filter="_onFilter"></paper-search-bar>
                            <paper-filter-dialog
                                id="filterDialog"
                                filters="[[searchFilters]]"
                                selected-filters="{{selectedSearchFilters}}"
                                save-button="Apply"
                                on-save="_searchFiltersChanged"></paper-filter-dialog>
                        </app-toolbar>
                    </div>

                    <paper-progress indeterminate hidden$="[[!_isLoading(loadingCount)]]"></paper-progress>
                </app-header>

                <main>
                    <iron-pages selected="[[page]]" attr-for-selected="name" selected-attribute="is-active">
                        <home-view name="home"></home-view>
                        <search-view id="searchView" name="search" search="{{search}}"></search-view>
                        <recipes-view name="recipes" route="[[subroute]]"></recipes-view>
                        <create-view name="create"></create-view>
                        <settings-view name="settings"></settings-view>
                        <login-view name="login"></login-view>
                        <status-404-view name="status-404"></status-404-view>
                    </iron-pages>
                </main>

                <footer>
                    <div class="indented" hidden$="[[!jwtToken]]">
                        <h4>Links</h4>
                        <ul>
                            <li><a href="/home">Home</a></li>
                            <li><a href="/search">Recipes</a></li>
                            <li><a href="/settings">Settings</a></li>
                            <li><a href="#!" on-tap="_onLogoutTapped">Logout</a></li>
                        </ul>
                    </div>
                    <div class="copyright indented">Copyright &copy; 2016-2018 Chad Weimer</div>
                </footer>
            </app-header-layout>
        </app-drawer-layout>

        <paper-toast id="toast" class="fit-bottom"></paper-toast>

        <app-localstorage-document key="search" data="{{search}}" session-only></app-localstorage-document>

        <iron-ajax bubbles
            id="appConfigAjax"
            url="/api/v1/app/configuration"
            method="GET"
            handle-as="json"
            on-response="_handleGetAppConfigurationResponse"></iron-ajax>
        <iron-ajax bubbles
            id="tagsAjax"
            url="/api/v1/tags"
            params='{"sort": "tag", "dir": "asc", "count": 100000}'
            method="GET"
            handle-as="json"
            on-response="_handleGetTagsResponse"></iron-ajax>
    </template>

    <script>
        class GompApp extends Polymer.GestureEventListeners(Polymer.Element) {
            static get is() { return 'gomp-app'; }
            static get properties() {
                return {
                    jwtToken: {
                        type: String,
                        notify: true,
                    },
                    title: {
                        type: String,
                        value: 'GOMP: Go Meal Planner',
                        observer: '_titleChanged',
                    },
                    page: {
                        type: String,
                        reflectToAttribute: true,
                        notify: true,
                        observer: '_pageChanged',
                    },
                    loadingCount : {
                        type: Number,
                        notify: true,
                        value: 0,
                    },
                    search: {
                        type: Object,
                        value: {
                            query: '',
                            fields: [],
                            tags: [],
                        },
                        notify: true,
                    },
                };
            }
            static get observers() {
                return [
                    '_routePageChanged(routeData.page)',
                    '_searchFieldsChanged(search.fields)',
                    '_searchTagsChanged(search.tags)',
                ];
            }

            ready() {
                super.ready();

                this.addEventListener('scroll-top', e => this._scrollToTop(e));
                this.addEventListener('home-list-link-clicked', e => this._onHomeLinkClicked(e));
                this.addEventListener('iron-overlay-opened', e => this._patchOverlay(e));
                this.addEventListener('recipes-modified', e => this._recipesModified(e));
                this.addEventListener('change-page', e => this._changePageRequested(e));
                this.addEventListener('iron-ajax-presend', e => this._onAjaxPresend(e));
                this.addEventListener('iron-ajax-request', e => this._onAjaxRequest(e));
                this.addEventListener('iron-ajax-response', e => this._onAjaxResponse(e));
                this.addEventListener('iron-ajax-error', e => this._onAjaxError(e));
                this.addEventListener('authenticated', e => this._onAuthenticated(e));
                this.addEventListener('show-toast', e => this._onShowToast(e));

                this.$.appConfigAjax.generateRequest();
            }

            _onAuthenticated(e) {
                // This is a workaround for a race condition  during login
                this.jwtToken = e.detail.jwtToken;
            }

            _titleChanged(title) {
                document.title = title;
                document.querySelector('meta[name="application-name"]').setAttribute('content', title);
                document.querySelector('meta[name="apple-mobile-web-app-title"]').setAttribute('content', title);
            }

            // https://github.com/PolymerElements/paper-dialog/issues/7
            _patchOverlay(e) {
                var path = e.path || (e.composedPath && e.composedPath());
                if (path) {
                    var overlay = path[0];
                    if (overlay.withBackdrop) {
                        overlay.parentNode.insertBefore(overlay.backdropElement, overlay);
                    }
                }
            }

            _isLoading(loadingCount) {
                return loadingCount !== 0;
            }

            _onAjaxPresend(e) {
               e.options.headers = {'Authorization': 'Bearer ' + this.jwtToken};
            }
            _onAjaxRequest(e) {
                this.loadingCount++;
            }
            _onAjaxResponse(e) {
                this.loadingCount--;
                if (this.loadingCount < 0) {
                    this.loadingCount = 0;
                }
            }
            _onAjaxError(e) {
                this.loadingCount--;
                if (this.loadingCount < 0) {
                    this.loadingCount = 0;
                }
                if (this.route.path !== '/login' && e.detail.request.xhr.status === 401) {
                    this._logout();
                }
            }

            _onShowToast(e) {
                this.$.toast.text = e.detail.message;
                this.$.toast.open();
            }

            _routePageChanged(page) {
                this.page = page || 'home';
            }
            _pageChanged(page) {
                if (this._verifyIsAuthenticated()) {
                    this.$.tagsAjax.generateRequest();
                }

                // Load page import on demand. Show 404 page if fails
                var resolvedPageUrl = this.resolveUrl(page + '-view.html');
                Polymer.importHref(resolvedPageUrl, null, () => this.page = 'status-404', true);

                // Make sure to close the drawer
                this.$.drawer.close();
            }
            _changePageRequested(e) {
                this._changeRoute(e.detail.url);
            }
            _changeRoute(path) {
                this.set('route.path', path);
            }
            _scrollToTop() {
                this.$.mainHeader.scroll(0, 0);
            }
            _onHomeTapped(e) {
                this._changeRoute('/home');
            }
            _onRecipesTapped(e) {
                this._changeRoute('/search');
            }
            _onSettingsTapped(e) {
                this._changeRoute('/settings');
            }
            _onLogoutTapped(e) {
                e.preventDefault();

                this._logout();
            }
            _verifyIsAuthenticated() {
                this.jwtToken = localStorage.getItem('jwtToken');
                // Redirect to login if necessary
                if (this.jwtToken === null) {
                    if (this.route.path !== '/login') {
                        this._logout();
                    }
                    return false;
                }
                return true;
            }
            _logout() {
                localStorage.clear();
                sessionStorage.clear();
                this.jwtToken = null;
                this._changeRoute('/login');
            }
            _onSearch(e) {
                this.set('search.query', e.target.query.trim());
                this._changeRoute('/search');
            }
            _onFilter() {
                this.$.filterDialog.open();
            }
            _onHomeLinkClicked(e) {
                this.set('search.query', '');
                this.set('search.fields', []);
                this.set('search.tags', e.detail.tags);
                this._changeRoute('/search');
            }
            _handleGetAppConfigurationResponse(e) {
                this.title = e.detail.response.title;
            }
            _handleGetTagsResponse(e) {
                var tags = e.detail.response;

                var filters = [];

                var fieldFilter = {id: 'fields', name: 'Search Fields', values: []};
                fieldFilter.values.push({id: 'name', name: 'Name'});
                fieldFilter.values.push({id: 'ingredients', name: 'Ingredients'});
                fieldFilter.values.push({id: 'directions', name: 'Directions'});
                filters.push(fieldFilter);

                var tagFilter = {id: 'tags', name: 'Tags', values: []};
                filters.push(tagFilter);
                if (tags) {
                    tags.forEach(function(tag) {
                        tagFilter.values.push({id: tag, name: tag});
                    });
                }

                this.searchFilters = filters;
            }
            _searchFiltersChanged(e) {
                if (this.selectedSearchFilters.fields) {
                    this.set('search.fields', this.selectedSearchFilters.fields);
                } else {
                    this.set('search.fields', []);
                }
                if (this.selectedSearchFilters.tags) {
                    this.set('search.tags', this.selectedSearchFilters.tags);
                } else {
                    this.set('search.tags', []);
                }
                this._changeRoute('/search');
            }
            _searchFieldsChanged(fields) {
                if (!this.selectedSearchFilters) {
                    this.selectedSearchFilters = {};
                }
                this.set('selectedSearchFilters.fields', fields);
            }
            _searchTagsChanged(tags) {
                if (!this.selectedSearchFilters) {
                    this.selectedSearchFilters = {};
                }
                this.set('selectedSearchFilters.tags', tags);
                // Only use tags for the number of selected filters
                this.selectedSearchFiltersCount = tags.length;
            }

            _recipesModified(e) {
                if (this.$.searchView.refresh) {
                    this.$.searchView.refresh();
                }
            }
        }

        window.customElements.define(GompApp.is, GompApp);
    </script>
</dom-module>
