<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/app-layout/app-layout.html">
<link rel="import" href="../bower_components/app-route/app-location.html">
<link rel="import" href="../bower_components/app-route/app-route.html">
<link rel="import" href="../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/paper-item/paper-icon-item.html">
<link rel="import" href="../bower_components/paper-item/paper-item.html">
<link rel="import" href="../bower_components/paper-menu/paper-menu.html">
<link rel="import" href="../bower_components/paper-progress/paper-progress.html">
<link rel="import" href="../bower_components/paper-search/paper-search-bar.html">
<link rel="import" href="../bower_components/paper-styles/default-theme.html">

<dom-module id="gomp-app">
    <template>
        <style>
            :root {
                --primary-color: var(--paper-blue-500);
                --accent-color: var(--paper-red-500);
                --light-accent-color: var(--paper-red-300);
                --dark-accent-color: var(--paper-red-700);
            }
            :host {
                display: block;
                @apply(--layout-fullbleed);
            }

            app-toolbar {
                background: var(--primary-color);
                color: white;
            }
            app-toolbar a {
                color: #ffffff;
            }
            paper-progress {
                width: 100%;
            }
            main {
                @apply(--layout-flex);
            }
            footer {
                color: white;
                background: var(--paper-grey-700);
                line-height: 24px;
                padding: 10px;
                font-weight: lighter;
                font-size: 0.8em;
            }
            @media screen and (min-width: 993px) {
                .hide-on-large-only {
                    display: none;
                }
            }
            @media screen and (max-width: 992px) {
                .hide-on-med-and-down {
                    display: none;
                }
            }
            @media screen and (max-width: 600px) {
                .hide-on-small-only {
                    display: none;
                }
            }
        </style>

        <app-location id="appLocation" route="{{route}}"></app-location>
        <app-route route="{{route}}" pattern="/:page" data="{{routeData}}" tail="{{subroute}}"></app-route>
        <app-scrollpos-control 
selected="{{page}}"></app-scrollpos-control>

        <app-drawer-layout id="drawerPanel" force-narrow fullbleed>
            <app-drawer swipe-open>
                <app-toolbar><span>[[title]]</span></app-toolbar>
                <paper-menu selected="[[page]]" attr-for-selected="name" fallback-selection="search" role="navigation">
                    <paper-icon-item name="home" on-tap="_onHomeTapped"><iron-icon icon="home" item-icon></iron-icon> Home</paper-icon-item>
                    <paper-icon-item name="search" on-tap="_onRecipesTapped"><iron-icon icon="view-list" item-icon></iron-icon> Recipes</paper-icon-item>
                    <paper-icon-item name="logout" on-tap="_onLogoutTapped"><iron-icon icon="exit-to-app" item-icon></iron-icon> Logout</paper-icon-item>
                </paper-menu>
            </app-drawer>
            <app-header-layout id="mainPanel" fullbleed>
                <app-header effects="material" reveals shadow>
                    <app-toolbar>
                        <paper-icon-button class="menu-button hide-on-large-only" icon="menu" drawer-toggle></paper-icon-button>
                        <div main-title><span class="hide-on-small-only">[[title]]</span></div>
                        <paper-item name="home" class="hide-on-med-and-down"><a href="/">Home</a></paper-item>
                        <paper-item name="search" class="hide-on-med-and-down"><a href="/search">Recipes</a></paper-item>
                        <paper-item name="logout" class="hide-on-med-and-down"><a href="#!" on-tap="_onLogoutTapped">Logout</a></paper-item>
                        <paper-search-bar icon="search" query="[[search]]" hide-filter-button="true" on-paper-search-search="_onSearch" on-paper-search-clear="_onSearch"></paper-search-bar>
                        <paper-progress indeterminate hidden$="[[!_isLoading(loadingCount)]]" bottom-item></paper-progress>
                    </app-toolbar>
                </app-header>

                <main>
                    <iron-pages selected="[[page]]" attr-for-selected="name">
                        <home-view
                            name="home"
                            jwt-token="[[jwtToken]]"
                            is-active="[[_isActive(page, 'home')]]"
                            title="[[homeTitle]]"
                            image="[[homeImage]]"></home-view>

                        <search-view
                            name="search"
                            jwt-token="[[jwtToken]]"
                            is-active="[[_isActive(page, 'search')]]"
                            search="{{search}}"
                            search-tags="{{searchTags}}"></search-view>

                        <recipes-view
                            name="recipes"
                            jwt-token="[[jwtToken]]"
                            is-active="[[_isActive(page, 'recipes')]]"
                            route="[[subroute]]"></recipes-view>

                        <create-view
                            name="create"
                            jwt-token="[[jwtToken]]"
                            is-active="[[_isActive(page, 'create')]]"></create-view>

                        <login-view
                            name="login"
                            jwt-token="[[jwtToken]]"
                            is-active="[[_isActive(page, 'login')]]"></login-view>
                    </iron-pages>
                </main>

                <footer>
                    <span>Copyright &copy; 2016 Chad Weimer</span>
                </footer>
            </app-header-layout>
        </app-drawer-layout>
    </template>

    <script>
        Polymer({

            is: 'gomp-app',

            properties: {
                jwtToken: {
                    type: String,
                    notify: true
                },
                title: {
                    type: String,
                    notify: true,
                    value: 'Go Meal Planner'
                },
                homeTitle: {
                    type: String,
                    notify: true,
                    value: 'Go Meal Planner'
                },
                homeImage: {
                    type: String,
                    notify: true,
                    value: ''
                },
                page: {
                    type: String,
                    reflectToAttribute: true,
                    notify: true,
                    observer: '_pageChanged'
                },
                search: {
                    type: String,
                    notify: true
                },
                searchTags: {
                    type: Array,
                    value: [],
                    notify: true
                },
                loadingCount: {
                    type: Number,
                    notify: true,
                    value: 0
                }
            },
            observers: [
                '_routePageChanged(routeData.page)'
            ],
            listeners: {
                'scroll-top': '_scrollToTop',
                'home-list-link-clicked': '_onHomeLinkClicked',
                'loading-started': '_loadingStarted',
                'loading-complete': '_loadingComplete'
            },

            ready: function() {
                this.verifyIsAuthenticated();
            },
            
            _loadingStarted: function(e) {
                this.loadingCount++;
            },
            _loadingComplete: function(e) {
                this.loadingCount--;
            },
            _isLoading: function(loadingCount) {
                return loadingCount > 0;
            },

            _routePageChanged: function(page) {
                this.page = page || 'home';
            },
            _pageChanged: function(page) {
                if (!this.verifyIsAuthenticated()) {
                    return;
                }

                // Load page import on demand. Show 404 page if fails
                var resolvedPageUrl = this.resolveUrl(page + '-view.html');
                this.importHref(resolvedPageUrl, null, null, true);

                // Make sure to close the drawer
                this.$.drawerPanel.closeDrawer();
            },
            _scrollToTop: function() {
                this.$.mainPanel.scrollToTop(true);
            },
            _onHomeTapped: function(e) {
                this.$.appLocation.path = "/";
            },
            _onRecipesTapped: function(e) {
                this.$.appLocation.path ="/search";
            },
            _onLogoutTapped: function(e) {
                e.preventDefault();
                this._logout();
            },
            verifyIsAuthenticated: function() {
                this.jwtToken = localStorage.getItem("jwtToken");
                // Redirect to login if necessary
                if (this.$.appLocation.path !== '/login') {
                    if (this.jwtToken === null) {
                        this._logout();
                        return false;
                    }
                }
                return true;
            },
            _logout: function() {
                localStorage.clear();
                sessionStorage.clear();
                this.$.appLocation.path = '/login';
            },
            _onSearch: function(e) {
                this.search = e.target.query.trim();
                this.$.appLocation.path = '/search';
            },
            _onHomeLinkClicked: function(e) {
                this.search = '';
                this.searchTags = e.detail.tags;
                this.$.appLocation.path = '/search';
            },
            _isActive: function(currentPage, pageToCheck) {
                return currentPage === pageToCheck;
            }
        });
    </script>
</dom-module>
