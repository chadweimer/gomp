<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../bower_components/iron-location/iron-location.html">
<link rel="import" href="../bower_components/iron-icons/image-icons.html">
<link rel="import" href="../bower_components/iron-icons/editor-icons.html">
<link rel="import" href="../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../bower_components/paper-fab-speed-dial/paper-fab-speed-dial.html">
<link rel="import" href="../bower_components/paper-fab-speed-dial/paper-fab-speed-dial-action.html">
<link rel="import" href="../bower_components/paper-input/paper-textarea.html">

<link rel="import" href="behaviors/gomp-core-behavior.html">

<link rel="import" href="components/image-list.html">
<link rel="import" href="components/note-list.html">
<link rel="import" href="components/recipe-display.html">
<link rel="import" href="components/recipe-edit.html">

<dom-module id="recipes-view">
    <template>
        <style>
            :host {
                display: block;
                color: var(--primary-text-color);
            }
            .container {
                padding: 8px;
            }
            paper-fab-speed-dial-action.green {
                --paper-fab-speed-dial-action-background: var(--paper-green-500);
                --paper-fab-speed-dial-action-keyboard-focus-background: var(--paper-green-900);
            }
            paper-fab-speed-dial-action.red {
                --paper-fab-speed-dial-action-background: var(--paper-red-500);
                --paper-fab-speed-dial-action-keyboard-focus-background: var(--paper-red-900);
            }
            paper-fab-speed-dial-action.amber {
                --paper-fab-speed-dial-action-background: var(--paper-amber-500);
                --paper-fab-speed-dial-action-keyboard-focus-background: var(--paper-amber-900);
            }
            paper-fab-speed-dial-action.teal {
                --paper-fab-speed-dial-action-background: var(--paper-teal-500);
                --paper-fab-speed-dial-action-keyboard-focus-background: var(--paper-teal-900);
            }
            paper-fab-speed-dial-action.blue {
                --paper-fab-speed-dial-action-background: var(--paper-blue-500);
                --paper-fab-speed-dial-action-keyboard-focus-background: var(--paper-blue-900);
            }
            #noteDialog h2 {
                color: var(--paper-blue-500);
            }
            .tab-container {
                @apply(--layout-horizontal);
                @apply(--layout-wrap);
            }
            .tab {
                margin: 8px;
            }
            @media screen and (min-width: 993px) {
                .tab {
                    width: calc(50% - 16px);
                }
                paper-dialog {
                    width: 33%;
                }
            }
            @media screen and (min-width: 601px) and (max-width: 992px) {
                .tab {
                    width: calc(100% - 16px);
                }
                paper-dialog {
                    width: 75%;
                }
            }
            @media screen and (max-width: 600px) {
                .tab {
                    width: calc(100% - 16px);
                }
                paper-dialog {
                    width: 100%;
                }
            }
        </style>

        <app-route id="appRoute" route="{{route}}" pattern="/:recipeId" data="{{routeData}}"></app-route>

        <div class="container">
            <recipe-display id="recipeDisplay" recipe-id="[[recipeId]]" jwt-token="[[jwtToken]]" hidden$="[[editing]]"></recipe-display>
            <recipe-edit id="recipeEdit" recipe-id="[[recipeId]]" jwt-token="[[jwtToken]]" hidden$="[[!editing]]"></recipe-edit>
            <div class="tab-container" hidden$="[[editing]]">
                <div id="images" class="tab">
                    <image-list id="imageList" jwt-token="[[jwtToken]]" recipe-id="[[recipeId]]"></image-list>
                </div>
                <div id="notes" class="tab">
                    <note-list id="noteList" jwt-token="[[jwtToken]]" recipe-id="[[recipeId]]"></note-list>
                </div>
            </div>
        </div>
        <paper-fab-speed-dial id="actions" icon="icons:more-vert" hidden$="[[editing]]">
            <a href="/create"><paper-fab-speed-dial-action id="newButton" class="green" icon="icons:add">New</paper-fab-speed-dial-action></a>
            <paper-fab-speed-dial-action id="deleteButton" class="red" icon="icons:delete">Delete</paper-fab-speed-dial-action>
            <paper-fab-speed-dial-action id="editButton" class="amber" icon="icons:create">Edit</paper-fab-speed-dial-action>
            <paper-fab-speed-dial-action id="addImageButton" class="teal" icon="image:add-a-photo">Upload Picture</paper-fab-speed-dial-action>
            <paper-fab-speed-dial-action id="addNoteButton" class="blue" icon="editor:insert-comment">Add Note</paper-fab-speed-dial-action>
        </paper-fab-speed-dial>

        <paper-dialog id="noteDialog" entry-animation="scale-up-animation" exit-animation="fade-out-animation" with-backdrop>
            <h2><iron-icon icon="editor:insert-comment"></iron-icon> <span>Add Note</span></h2>
            <paper-textarea label="Text" value="{{noteText}}" rows="3" required autofocus></paper-textarea>
            <div class="buttons">
                <paper-button dialog-dismiss>Cancel</paper-button>
                <paper-button dialog-confirm>Save</paper-button>
            </div>
        </paper-dialog>

        <paper-dialog id="confirmDialog" entry-animation="scale-up-animation" exit-animation="fade-out-animation" with-backdrop>
            <h2><iron-icon icon="communication:live-help"></iron-icon> <span>Are you sure?</span></h2>
            <p>[[confirmationText]]</p>
            <div class="buttons">
                <paper-button dialog-dismiss>No</paper-button>
                <paper-button id="confirmYes" dialog-confirm>Yes</paper-button>
            </div>
        </paper-dialog>

        <iron-ajax
            id="deleteAjax"
            url="/api/v1/recipes/[[recipeId]]"
            method="DELETE"
            headers="[[ajaxHeaders]]"
            handle-as="json"
            on-request="_handleRequest"
            on-response="_handleDeleteRecipeResponse"
            on-error="_handleError"></iron-ajax>
        <iron-ajax
            id="postNoteAjax"
            url="/api/v1/notes"
            method="POST"
            headers="[[ajaxHeaders]]"
            handle-as="json"
            on-request="_handleRequest"
            on-response="_handlePostNoteResponse"
            on-error="_handleError"></iron-ajax>
        <iron-ajax
            id="putNoteAjax"
            url="/api/v1/notes/[[noteId]]"
            method="PUT"
            headers="[[ajaxHeaders]]"
            handle-as="json"
            on-request="_handleRequest"
            on-response="_handlePutNoteResponse"
            on-error="_handleError"></iron-ajax>
        <iron-location id="ironLocation"></iron-location>
    </template>

    <script>
        Polymer({

            is: 'recipes-view',
            behaviors: [GompCoreBehavior],

            properties: {
                route: {
                    type: Object,
                    notify: true
                },
                recipeId: {
                    type: String,
                    notify: true
                },
                editing: {
                    type: Boolean,
                    notify: true,
                    value: false
                }
            },
            observers: [
                '_recipeIdChanged(routeData.recipeId)'
            ],
            listeners: {
                'newButton.tap': '_newButtonTapped',
                'deleteButton.tap': '_deleteButtonTapped',
                'editButton.tap': '_editButtonTapped',
                'addImageButton.tap': '_addImageButtonTapped',
                'addNoteButton.tap': '_addNoteButtonTapped',
                'noteDialog.iron-overlay-closed': '_noteDialogClosed',
                'note-card-edit': '_editNoteTapped',
                'image-list-main-image-changed': '_mainImageChanged',
                'recipeEdit.recipe-edit-cancel': '_editCanceled',
                'recipeEdit.recipe-edit-save': '_editSaved'
            },

            refresh: function() {
                this.$.recipeDisplay.refresh();
                this.$.imageList.refresh();
                this.$.noteList.refresh();
            },

            _isActiveChanged: function(active) {
                // Always exit edit mode when we change screens
                this.editing = false;
            },

            _recipeIdChanged: function(recipeId) {
                this.recipeId = recipeId;
            },

            _newButtonTapped: function(e) {
                this.$.actions.close();
            },
            _deleteButtonTapped: function(e) {
                this.confirmationText = "Are you sure you want to delete this recipe?";
                var self = this;
                this.$.confirmYes.onclick = function(e) {
                    self.$.deleteAjax.generateRequest();
                };
                this.$.confirmDialog.open();
                this.$.actions.close();
            },
            _editButtonTapped: function(e) {
                this.$.actions.close();
                this.$.recipeEdit.refresh();
                this.editing = true;
            },
            _editCanceled: function(e) {
                this.editing = false;
                this.refresh();
            },
            _editSaved: function(e) {
                this.editing = false;
                this.refresh();
            },

            _addImageButtonTapped: function(e) {
                this.$.actions.close();
                this.$.imageList.add();
            },

            _addNoteButtonTapped: function(e) {
                this.noteId = null;
                this.noteText = '';
                this.$.actions.close();
                this.$.noteDialog.open();
            },
            _noteDialogClosed: function(e) {
                if (e.detail.confirmed) {
                    if (this.noteId) {
                        this.$.putNoteAjax.body = JSON.stringify({
                            "id": this.noteId,
                            "recipeId": this.recipe.id,
                            "text": this.noteText
                        });
                        this.$.putNoteAjax.generateRequest();
                    } else {
                        this.$.postNoteAjax.body = JSON.stringify({"recipeId": this.recipe.id, "text": this.noteText });
                        this.$.postNoteAjax.generateRequest();
                    }
                }
            },
            _editNoteTapped: function (e) {
                this.noteId = e.target.note.id;
                this.noteText = e.target.note.text;
                this.$.noteDialog.open();
            },

            _mainImageChanged: function(e) {
                this.$.recipeDisplay.refresh({onlyMainImage: true});
                this.fire("scroll-top");
            },

            _handleDeleteRecipeResponse: function(e) {
                this.$.ironLocation.set("path", "/search");
            },
            _handlePostNoteResponse: function(e) {
                this.$.noteList.refresh();
            },
            _handlePutNoteResponse: function(e) {
                this.$.noteList.refresh();
                this.onLoaded();
            },
            _handleRequest: function(e) {
                this.onLoading();
            },
            _handleError: function(e) {
                this.onLoaded();
            }

        });
    </script>
</dom-module>
